#!/bin/sh

# Ensure we are in the target directory
cd /scripts || exit 1

# Configure git to trust the mounted volume directory
# (Prevents "fatal: detected dubious ownership" errors in Docker)
git config --global --add safe.directory /scripts 2>/dev/null

# Function to list files to process
get_files() {
  if command -v git >/dev/null 2>&1 && git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
    # GIT MODE: Use git to list files, automatically respecting .gitignore
    # --cached: tracked files
    # --others: untracked files
    # --exclude-standard: apply .gitignore rules
    git ls-files --cached --others --exclude-standard | while read -r f; do
      # The original script only linted executable files, so we check permissions here
      if [ -x "$f" ] && [ -f "$f" ]; then
        echo "$f"
      fi
    done
  else
    # FALLBACK MODE: Original logic if not a git repo
    find . -type f -executable ! -path '*/.*'
  fi
}

# Run the pipeline
get_files | \
  xargs -I {} file {} | \
  grep 'Bourne-Again shell script\|POSIX shell script' | \
  cut -d: -f1 | \
  xargs -r shfmt -i 2 -w
